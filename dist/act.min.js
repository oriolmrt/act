!function(e){document.addEventListener("DOMContentLoaded",()=>{xe.configure(),xe.config.start&&xe.start()});const t=(e,...t)=>{if(null==e)return!1;for(const s of t)if(e instanceof s||e?.constructor===s)return!0;return!1},s=e=>t(e,x)?e.value:e,n=e=>e.map(s),r=e=>t(e,x)?e.from:void 0,i=e=>t(e,x)?e.through:e,a=e=>{if(t(e,T)&&(e=e.value),"string"!=typeof e)return e;const s=e.toLowerCase().replace(/[-_][a-z]/g,e=>e[1].toUpperCase());return"innerhtml"===s.toLowerCase()?"innerHTML":"outerhtml"===s.toLowerCase()?"outerHTML":s},o=(e,t)=>null==t?e:xe.config.convertToCamelCase&&void 0!==t[a(e)]?a(e):e,l=e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),c={ActMethod:class{constructor(e){this.method=e}},method:e=>new c.ActMethod(e),get(e,s){return t(s,Element)&&Object.hasOwn(this.Element,e)?this.Element[e]:Array.isArray(s)&&Object.hasOwn(this.Array,e)?this.Array[e]:Object.hasOwn(this[typeof s],e)?this[typeof s][e]:Object.hasOwn(this.globals,e)?this.globals[e]:void 0},async exec(e,s,n,r,i){return t(e,x)?await this.exec(e.value,s,e.parent,e.context||r,i):t(e,c.ActMethod)?await e.method(r,n,i,...s):t(e,Function)?await e.call(n,...await r.solveAll(s,n)):void 0}};c.words={me:(e,t)=>t,source_element:e=>e.binding.element,original_target:e=>e.target,undefined:()=>{},NaN:()=>NaN,debugger:()=>{},true:()=>!0,false:()=>!1,null:()=>null,document:()=>document,window:()=>window,js:()=>window,Act:()=>xe},c.prefixes={global(e,t,s,n){return new x(xe.globals[n.value],this,{parent:xe.globals,key:n.value})},local(e,t,s,n){const r=ue.from(t,!0).data;return new x(r[n.value],this,{parent:r,key:n.value})},scoped(e,t,s,n){const r=e.scopeData(this.scope);return new x(r[n.value],this,{parent:r,key:n.value})},not:async(e,t,s,n)=>!await e.asValueOf(n,t),negative:async(e,t,s,n)=>-await e.asValueOf(n,t),async type(e,t,n,i){const a=await e.solve(i,t,n);return r(a)?.constructor.name||typeof s(a)},async wat(e,t,s,n){const r=await e.solve(n,t,s);return console.log("ðŸ¤· Act WAT?\n","Value:",n,"\n","Result:",r,"\n","Target:",t,"\n","Scope:",this.scope,"\n","Context:",e,"\n","Code:",n.code,"\n"),r}};const h=async(e,t,s,n,r)=>{const i=new e;throw void 0!==r&&(i.data=await t.solve(r,s,n)),i};c.keywords={async run(e,t,s,[n,...r]){n=await e.asString(n,t);const i=e.binding.getBlock(n);if(!i)throw new y(`Block '${n}' not found.`);const a=e.scopeData(i.scope);a.__fromScope__=this.scope;for(let n=0;n<i.args.length;n++){const o=i.args[n];if(Array.isArray(o)){a[o[0]]=await Promise.all(r.slice(n).map(n=>e.solve(n,t,s)));break}a[o]=await e.solve(r[n],t,s)}return await e.solve(i.scope,t,s)},def(e,s,n,r){const i=r[0].value,a=r[r.length-1],o=r.slice(1,-1).map(e=>t(e,_)?[e.value[0].value]:e.value);ue.from(s,!0).blocks[i]={args:o,scope:a}},async each(e,s,n,r){let i,a=s,o=r[0];if(t(r[1],P)&&"in"===r[1].value)i=r[0].value,a=await e.asValueOf(r[2],s),o=r[3];else if(t(r[2],P)&&"in"===r[2].value){a=await e.asValueOf(r[3],s),o=r[4];for(const[s,i]of Object.entries(a)){e.scopeData(o)[r[0].value]=s,e.scopeData(o)[r[1].value]=i;try{await e.solve(o,a,n)}catch(e){if(t(e,O.Break))return e.data;if(t(e,O.Continue))continue;throw e}}return a}for(let r of a)try{i&&(e.scopeData(o)[i]=new x(r,this)),await e.solve(o,i?s:r,n)}catch(e){if(t(e,O.Break))return e.data;if(t(e,O.Continue))continue;throw e}},async for(e,s,n,r){const i=r[0].value;let a=1,o=0;if("from"===r[a].value&&(o=await e.asValueOf(r[2],s),a+=2),"to"!==r[a].value)throw new y('Invalid for loop syntax: missing "to" word.');const l=await e.asValueOf(r[a+1],s);a+=2;let c=1,h=!1;"step"==r[a].value&&(c=await e.asValueOf(r[a+1],s),h=!0);const u=r.at(-1),p=o<=l;h||(c=p?1:-1);for(let n=o;p?n<=l:n>=l;n+=c)try{e.scopeData(u)[i]=n,await e.solve(u,s)}catch(e){if(t(e,O.Break))return e.data;if(t(e,O.Continue))continue;throw e}},if:async(e,t,s,[n,r,i,a])=>await e.asValueOf(n,t)?await e.solve(r,t,s):"else"===await e.asString(i,t)?await e.solve(a,t,s):void 0,async loop(e,s,n,[r]){for(;;)try{await e.solve(r,s,n)}catch(e){if(t(e,O.Break))return e.data;if(t(e,O.Continue))continue;throw e}},async new(e,s,n,[r,...i]){if(t(r,H))return document.createElement(r.value);let a=await e.asValueOf(r,s);i=await e.solveAll(i,s,n);try{return new a(...i)}catch(e){return new(window[a.toString()])(...i)}},async on(e,s,n,[r,...i]){s=await e.asValueOf(s),r=ue.eventName(await e.asString(r,s));let a={};t(i[0],X)&&(a=await e.asValueOf(i[0],s));const o=ue.from(s,!0),l=i.at(-1),c=new de(o,r,a,l.source,l);return o.addEvent(r,l.source,a,c),!0},async off(e,t,s,[n]){t=await e.asValueOf(t);const r=ue.from(t);return!!r&&(n=ue.eventName(await e.asString(n,t)),r.element.removeEventListener(n,r.events[n].listener),delete r.events[n],!0)},async kill(e,s,n,[r]){if(s=await e.asValueOf(s),!t(s,Element))return!1;const i=ue.from(s);if(!i)return!1;r=ue.eventName(await e.solve(r,s,n));const a=i.events[r];return!!a&&(a.contexts.size>0&&(a.halt=!0))},break:(e,t,s,[n])=>h(O.Break,e,t,s,n),stop:(e,t,s,[n])=>h(O.Stop,e,t,s,n),return:(e,t,s,[n])=>h(O.Return,e,t,s,n),repeat(){throw new O.Repeat},restart(){throw new O.Restart},continue(){throw new O.Continue},halt(){throw new O.Halt},async throw(e,s,n,[r]){if(t(r,Error))throw r;throw new y(await e.asValueOf(r,s))},async while(e,s,n,[r,i]){for(;await e.asValueOf(r,s);)try{await e.solve(i,s,n)}catch(e){if(t(e,O.Break))return e.data;if(t(e,O.Continue))continue;throw e}},async with(e,t,n,[r,i]){const a=await e.solve(r,t,n);return await e.solve(i,s(a),n),a}},c.globals={listens_to(e){const t=ue.from(this);return t&&Object.hasOwn(t.events,e?.toString()??"")},is_running(e=null){const t=ue.from(this);if(!t)return null;if(null===e){for(const e of Object.values(t.events))if(e.contexts.size>0)return!0;return!1}const s=t.events[ue.eventName(e.toString())];return!!s&&s.contexts.size},async tick(){await new Promise(e=>requestAnimationFrame(e))},wait:e=>new Promise(t=>setTimeout(t,c.globals.time_to_ms(e))),log_raw:(...e)=>console.log(...e),log:(...e)=>console.log(...n(e)),warn:(...e)=>console.warn(...n(e)),error:(...e)=>console.error(...n(e)),time_to_ms(e){if("number"==typeof e)return e;e=e.toString();const t=e.match(/[a-z]+$/)?.[0],s=parseFloat(e);return t?s*({ms:1,s:1e3,m:6e4,h:36e5}[t]||1):isNaN(s)?0:s},random(e,t){const s=Math.random()*(t-e+1)+e;return e%1+t%1==0?Math.floor(s):s},delay:c.method(async function(e,t,s,n,r){clearTimeout(r.__delayTimeout__||0);const i=c.globals.time_to_ms(await e.solve(n,t,s));return new Promise(n=>{r.__delayTimeout__=setTimeout(async()=>{n(await e.solve(r,t,s)),delete r.__delayTimeout__},i)})}),lock:c.method(async function(e,t,s,...n){if(0===n.length)return e.eventManager.lock=!0;const r=await e.asValueOf(n[0],t);if("boolean"==typeof r)return e.eventManager.lock=r;const i=ue.from(t);if(!i)return null;const a=i.events[ue.eventName(await e.asString(n[0],t))];return a?(a.lock=void 0===n[1]||!!await e.asValueOf(n[1],t),!0):null}),unlock:c.method(async function(e,t,s,...n){if(0===n.length)return!(e.eventManager.lock=!1);const r=ue.from(t);if(!r)return null;const i=r.events[ue.eventName(await e.asString(n[0],t))];return i&&(i.lock=!1),!0}),is_locked:c.method(async function(e,t,s,...n){if(0===n.length)return e.eventManager.lock;const r=ue.from(t);return r?r.events[ue.eventName(await e.asString(n[0],t))]?.lock:null})},c.Array=function(){const e=e=>c.method(async(s,n,r,i)=>{i=await s.solve(i,n,r);const a=e=>t(i,c.ActMethod)?i.method(s,n[e],r,n[e],e,n):i(n[e],e,n);if("map"===e)return Promise.all(n.map((e,t)=>a(t)));if("filter"===e){const e=await Promise.all(n.map((e,t)=>a(t)));return n.filter((t,s)=>e[s])}for(let t=0;t<n.length;t++){const s=await a(t);if("find"===e&&s)return n[t];if("find_index"===e&&s)return t;if("some"===e&&s)return!0;if("every"===e&&!s)return!1}return"find_index"===e?-1:"some"!==e&&("every"===e||void 0)});return{map:e("map"),filter:e("filter"),for_each:e("for_each"),find:e("find"),find_index:e("find_index"),some:e("some"),every:e("every")}}();const u=e=>{const n=r(i(e)),a=t(n,W),o=t(n,j);return{isClass:a,isAttribute:o,name:a||o?n.value:(s(e)??"").toString()}},p=(e,n,r)=>{const i=s(n);return t(i,Element)?"afterbegin"===r?e.insertBefore(i,e.firstChild):e.appendChild(i):e.insertAdjacentHTML(r,(e=>{if(!xe.config.sanitize)return e;if("function"==typeof xe.config.sanitizer)return xe.config.sanitizer(e);throw new y("Act: sanitize is enabled but no sanitizer function provided. Set Act.config.sanitizer to a function (e.g., DOMPurify.sanitize).")})(i.toString())),e},d=(e,n,r="beforeend")=>{if("string"==typeof(n=s(n))&&(n=document.querySelector(n)),!n)return e;const i=t(e,DocumentFragment,HTMLCollection,NodeList)||Array.isArray(e)?e.childNodes?Array.from(e.childNodes):Array.from(e):[e],a=r.toString().toLowerCase(),o={before:"beforebegin",prepend:"afterbegin",append:"beforeend",after:"afterend",inside:"innerhtml",replace:"outerhtml"}[a]||a;"innerhtml"===o&&(n.innerHTML="");const l=n.parentNode,c={beforebegin:e=>l.insertBefore(e,n),afterbegin:e=>n.insertBefore(e,n.firstChild),beforeend:e=>n.appendChild(e),afterend:e=>l.insertBefore(e,n.nextSibling),innerhtml:e=>n.appendChild(e),outerhtml:e=>l.insertBefore(e,n)},h=c[o]||c.beforeend;return"afterbegin"===o&&i.reverse(),i.forEach(e=>h(e)),"outerhtml"===o&&n.remove(),e},f=(e,s,n)=>{if(!s)return n?e.nextElementSibling:e.previousElementSibling;let r;r="string"==typeof s?document.querySelectorAll(s):t(s,Element)?[s]:t(s,NodeList)||Array.isArray(s)?s:document.querySelectorAll(s.toString());const i=n?4:2;if(n){for(const t of r)if(e.compareDocumentPosition(t)&i)return t}else for(let t=r.length-1;t>=0;t--)if(e.compareDocumentPosition(r[t])&i)return r[t];return null};c.Element={matches(e){return this.matches(e.toString())},hide(){this.style.display="none"},show(){this.style.display=""},transition(...e){let t="",s=0,n={},r=this.style.transition;for(;e.length;){let r=0,i="",a=0,o=e.shift().toString();const l=()=>e.shift().toString(),h={from:()=>this.style[o]=l(),to:()=>n[o]=l(),in:()=>r=c.globals.time_to_ms(l()),using:()=>i=l(),after:()=>a=c.globals.time_to_ms(l())};for(;e.length&&h[e[0]];)h[e.shift()]();s=Math.max(s,a+r),t+=`${t?", ":""}${o} ${r}ms${i?" "+i:""}${a?" "+a+"ms":""}`}return this.style.transition=t,Object.assign(this.style,n),new Promise(e=>setTimeout(()=>{this.style.transition=r,e()},s))},trigger(e,t=!0,n={}){return this.dispatchEvent(new CustomEvent(ue.eventName(e),{bubbles:t,detail:s(n)})),this},move_to(e,t="beforeend"){return d(this,e,t)},empty(){this.replaceChildren()},prepend(e){return p(this,e,"afterbegin")},append(e){return p(this,e,"beforeend")},fade(e,t=250,s="linear"){return this.animate([{opacity:"in"===e?0:1},{opacity:"in"===e?1:0}],{duration:c.globals.time_to_ms(t),easing:s,fill:"forwards"}).finished.then(()=>{this.style.opacity="in"===e?"1":"0"})},remove:c.method(async function(e,s,n,...r){for(const e of r){if(void 0===e)return s.parentNode?.removeChild(s);t(e,W)?s.classList.remove(e.value.slice(1)):t(e,j)&&s.removeAttribute(e.value)}return s}),collapse(e=250,t="linear"){const s=window.getComputedStyle(this),n=[{height:this.offsetHeight+"px"},{height:"0px"}];return["marginTop","marginBottom","paddingTop","paddingBottom","borderTopWidth","borderBottomWidth"].forEach(e=>{n[0][e]=s[e],n[1][e]="0px",n[0].overflow=n[1].overflow="hidden"}),this.animate(n,{duration:c.globals.time_to_ms(e),easing:t}).finished.then(()=>this.remove())},is_in_view(e=!1){const{top:t,left:s,bottom:n,right:r}=this.getBoundingClientRect(),{innerHeight:i,innerWidth:a}=window,o=t>=0&&s>=0&&n<=i&&r<=a;return o||!e?o:t<i&&n>0&&s<a&&r>0&&"partially"},next(e){return f(this,e,!0)},previous(e){return f(this,e,!1)},parent(){return this.parentNode},on_match:c.method(async function(e,t,s,n,r,i){n=ue.eventName(await e.asString(n,t)),r=await e.asString(r,t);const a=ue.from(t,!0),o=new de(a,n,{},i.source,i);return o.listener=e=>{let s=e.target;for(;s&&s!==t;){if(s.matches(r))return o.run(s,e);s=s.parentElement}if(t.matches(r)&&s===t)return o.run(t,e)},a.addEvent(n,i.source,{},o),!0}),take(e,n){const r=n?t(s(n),NodeList)?s(n):[s(n)]:[...this.parentNode?.children||[]].filter(e=>e!==this),{isClass:i,isAttribute:a,name:o}=u(e);return r.forEach(e=>{a&&e.hasAttribute(o)&&(this.setAttribute(o,e.getAttribute(o)),e.removeAttribute(o)),i&&e.classList.contains(o.slice(1))&&(this.classList.add(o.slice(1)),e.classList.remove(o.slice(1)))}),this},toggle:c.method(async function(e,t,n,...r){if(0===r.length)return"none"===t.style.display?c.Element.show.call(t):c.Element.hide.call(t);const[i,a]=r,o=await e.solve(i,t),{isClass:l,isAttribute:h,name:p}=u(o);let d=a?s(await e.solve(a,t)):void 0;return l?t.classList.toggle(p.slice(1),d):h?t.toggleAttribute(p,d):void 0!==d?d?c.Element.show.call(t):c.Element.hide.call(t):"none"===t.style.display?c.Element.show.call(t):c.Element.hide.call(t)}),add:c.method(async function(e,s,n,...r){for(const e of r)t(e,W)?s.classList.add(e.value.slice(1)):t(e,j)&&s.setAttribute(e.value,"");return s}),has:c.method(async function(e,t,s,n){const{isClass:r,isAttribute:i,name:a}=u(await e.solve(n,t));return r?t.classList.contains(a.slice(1)):i?t.hasAttribute(a):t.matches(a)})},c.function={},c.object={first(){if((Array.isArray(this)||t(this,HTMLCollection,NodeList))&&this.length>0)return this[0]},last(){if((Array.isArray(this)||t(this,HTMLCollection,NodeList))&&this.length>0)return this[this.length-1]},move_to(e,t){return d(this,e,t)}},c.boolean={},c.number={},c.bigint={},c.string={after(e){const[t,s]=[this.toString(),e.toString()],n=t.indexOf(s);return-1===n?t:t.substring(n+s.length)},before(e){const[t,s]=[this.toString(),e.toString()],n=t.indexOf(s);return-1===n?t:t.substring(0,n)},between(e,t){const[s,n,r]=[this.toString(),e.toString(),t.toString()],i=s.indexOf(n);return-1===i?s:s.substring(i+n.length,s.indexOf(r))},capitalize(){return this.toString().charAt(0).toUpperCase()+this.toString().slice(1)}},c.symbol={},c.undefined={};class x{from;_value;parent;key;constructor(e,t=null,s={}){this._value=e,this.from=t;for(const[e,t]of Object.entries(s))this[e]=t}get settable(){return this.parent&&void 0!==this.key}set(e){t(e,v)||(e=s(e)),this.parent[this.key]=e}get value(){return t(this._value,x)?this._value.value:this.parent&&this.key?this.parent[this.key]:this._value}get through(){return t(this._value,x)?this._value.through:this}valueOf(){return this.value?.valueOf()}toString(...e){return t(this._value,x)?this.through.toString(...e):this._value?.toString(...e)}}class m extends x{set(e){const s=t(e,x)?e.toString():String(e);this.parent.setAttribute(this.key,s)}get value(){return this.parent.getAttribute(this.key)}}class v extends x{}class w extends v{valueOf(){return this.value.number.valueOf()}toString(){return Object.values(this.value).join("")}}class g extends v{get value(){return document.getElementById(this._value.slice(1))}}class k extends v{get value(){return"closest"===this.mode?this.parent.closest(this._value):this.parent.querySelectorAll(this._value)}toString(){return this._value}valueOf(){return this.value}}class b extends Error{}class y extends b{}class E extends y{}class S extends y{}class O extends b{static Break=class extends(this){};static Continue=class extends(this){};static Stop=class extends(this){};static Halt=class extends(this){};static Repeat=class extends(this){};static Restart=class extends(this){};static Return=class extends(this){}}class T{scope;source;tokenStart;tokenEnd;value;constructor(e,t,s={}){this.scope=e,this.source=t;for(const[e,t]of Object.entries(s))void 0!==t&&(this[e]=t);xe.config.debug&&console.log(`Act debug. ${this.constructor.name} created.\n`,this,"\n")}get code(){return this.source.code.substring(this.tokenStart.index,this.tokenEnd.indexEnd)}solve(){return this.value}solveDebug(e,t,s){console.log(`Act: solve() debug. ${this.constructor.name} solved.\n`,`${this.constructor.name}:`,this,"\n","Code:",this.code,"\n","Result value:",s,"\n","Target:",t,"\n","Context:",e,"\n")}}class _{constructor(e=[]){this.value=Array.isArray(e)?e:[e]}expand(){const e=[];for(let s of this.value)t(s,this.constructor)?e.push(...s.expand()):e.push(s);return e}async solve(e,s,n){const r=[];for(let i of this.expand())t(i,T)?r.push(await e.solve(i,s,n)):r.push(i);return r}push(e){this.value.push(e)}}class A extends T{async solve(e,t,n){const r=await e.solve(this.value,t,n);return Array.isArray(s(r))?s(r):[r]}}class I extends T{static interpolation(e){return`î€€_act_itpl_:${e}î€€`}async solve(e,n,r){if(!this.value.scope)return this.value.template;let i,a=[],o=this.value.template;for(let l=0;l<this.value.scope.value.length;l++){if(i="",a.shift()){o=o.replace(I.interpolation(l),"");continue}const c=this.value.scope.value[l];try{i="async"==c.mode?c.solve(e,n,r):await c.solve(e,n,r),"condition"==c.mode?a=[!s(i),"branch"==this.value[l+1]?.mode&&!!s(i)]:"fwd"==c.mode&&(n=s(i))}catch(e){if(t(e,O.Stop))return e.data;if(!t(e,O.Repeat))throw e;l=-1}finally{o=o.replace(I.interpolation(l),i.toString())}}return o}}class C extends T{solve(){return this.value}}class N extends C{}class L extends C{}class R extends C{}class M extends T{static REGEX=/^(-)?\d+(\.\d+)?[a-z%]+$/;constructor(e,t,s={}){super(e,t,s),this.unit=this.value.match(/[a-z%]+/)[0],this.number=parseFloat(this.value.match(/(-)?\d+(\.\d+)?/)[0])}solve(){return new w({number:this.number,unit:this.unit},this)}}class P extends C{isReservedWord(){return Object.hasOwn(c.words,this.value)}async solve(e,t,s){return this.isReservedWord()?await e.solve(await c.words[this.value].call(t,e,t),t,s):this.value}}class $ extends T{solve(e,t){if(null==t)return new x(void 0,this,{parent:t,key:this.value});if(xe.config.convertToCamelCase){const e=a(this.value);void 0!==t[e]&&(this.value=e)}return new x(t[this.value],this,{parent:t,key:this.value})}}class V extends T{isGlobal(){return this.value[0]===this.value[0].toUpperCase()&&this.value[0]!==this.value[0].toLowerCase()}solve(e,t){if(this.isGlobal())return new x(ue.from(document.body).data[this.value],this,{parent:ue.from(document.body).data,key:this.value});let s=this.scope.lookup(e,this.value);return s||(s=e.binding.lookupData(this.value)),s||(s=new x(e.scopeData(this.scope)[this.value],this,{parent:e.scopeData(this.scope),key:this.value})),s.from=this,s}}class j extends T{solve(e,t){return new m(t.attributes[this.value]?.value,this,{parent:t,key:this.value})}}class D extends T{solve(e,t,s){const n=getComputedStyle(t)[this.value],r=n.match(M.REGEX);if(r&&r.length&&void 0!==r[0]){const n=new M(this.scope,this.source,{value:r[0],tokenStart:this.tokenStart,tokenEnd:this.tokenEnd});return new x(n.solve(e,t,s),this,{parent:t.style,key:this.value})}return new x(n,this,{parent:t.style,key:this.value})}}class z extends T{solve(e,t,s){return new k(this.value,this,{parent:document})}}class B extends T{async solve(e,s,n){let r=await e.asString(this.value),i=n?.selectorTarget||document;if(r.startsWith("> "))i=s,r=r.slice(2);else if(r.startsWith("< "))return i=t(s,Element)?s:e.target,new k(r.slice(2),this,{parent:i,mode:"closest"});return new k(r,this,{parent:i})}}class U extends z{async solve(e,t,s){return new g(this.value,this)}}class H extends z{}class W extends z{async solve(e,t,s){return new k(this.value,this,{parent:document})}}class F extends T{mode="sync";target;async solve(e,n,r){let i,a=n;try{void 0!==this.target?a=await e.asValueOf(this.target,n):void 0===n&&(a=e.target),i=await this.value.solve(e,s(a),r)}catch(s){if(t(s,O))throw s;if(!t(s,S)){const e=new S(s.message);e.actException=s,e.actTrace=[],s=e}throw s.actTrace=s.actTrace||[],s.actTrace.push({sentence:this,sentenceTarget:a,target:n,context:e}),s}return xe.config.debug&&this.solveDebug(e,n,i),i}}class G extends T{value=[];isRoot(){return void 0===this.scope}async solve(e,n,r){let i,a=[];for(let o=0;o<this.value.length;o++){if(a.shift())continue;const l=this.value[o];try{i="async"==l.mode?l.solve(e,n,r):await l.solve(e,n,r),"condition"==l.mode?a=[!s(i),"branch"==this.value[o+1]?.mode&&!!s(i)]:"fwd"==l.mode&&(n=i)}catch(e){if(t(e,O.Stop))return e.data;if(!(t(e,O.Repeat)||this.isRoot()&&t(e,O.Restart)))throw e;o=-1}}return this.constructor.debug&&this.solveDebug(e,n,i),i}lookup(e,s,n=!1){let r=this;for(;r;){const n=e.scopeData(r);if(void 0!==n[s])return new x(n[s],r,{parent:n,key:s});r=t(n.__fromScope__,this.constructor)?n.__fromScope__:r.scope}if(n)return e.scopeData(r)}}class K extends T{async solve(e,s,n){const r=[];for(const i of this.value)t(i,A)?r.push(...await e.solve(i,s,n)):r.push(await e.solve(i,s,n));return r}}class X extends T{async solve(e,t,s){const n={};for(const[r,i]of this.value){const a=await e.asString(r,t);n[a]=await e.solve(i,t,{...s,parent:n,key:a})}return n}}class q extends T{async solve(e,s,r){const i=this.value.scope,a=this.value.args;return c.method(async function(e,s,o,...l){const c=e.spawn(),h=c.scopeData(i);h.event=c.event,h.this=r?.parent;const u=await e.solveAll(l,s,r);for(let e=0;e<a.length;e++){if(Array.isArray(a[e])){h[a[e][0]]=n(u.slice(e));break}h[a[e]]=u[e]}try{return await c.solve(i,s,r)}catch(e){if(t(e,O.Return))return e.data;throw e}})}}class Z extends T{async prepare(e,t,s){return{l:await e.solve(this.l,t,s),r:await e.solve(this.r,t,s)}}async performWith(e,t,s,n){const{l:r,r:i}=await this.prepare(e,t,s);return n(r,i)}async solve(e,s,n){let r;try{r=await this.perform(e,s,n)}catch(e){if(t(e,O))throw e;if(t(e,S))throw e;const s=new S;throw s.expression=this,s.actException=e,s.actTrace=[],s}return xe.config.debug&&this.solveDebug(e,s,r),r}}class J extends Z{async perform(e,t,s){const n=this.l.value.toString(),r=this.r.expand();return await e.solve(await c.keywords[n].call(this,e,t,s,r),t)}}class Y extends Z{async perform(e,t,s){const n=this.l.toString();return await e.solve(await c.prefixes[n].call(this,e,t,s,this.r),t)}}async function Q(e,r,i,a,o,l){if(t(s(a),c.ActMethod))return{solved:!0,result:await s(a).method(e,a.parent??r,i,...o)};if(t(s(a),Function)){const n=(await e.solveAll(o,r,i)).map(n=>t(s(n),c.ActMethod)?(...t)=>s(n).method(e,r,i,...t):s(n));return{solved:!0,result:await s(a).call(a.parent??r,...n)}}if("string"==typeof s(a)){const a=c.get(l,r);if(void 0!==a)return{solved:!0,result:await c.exec(a,o,r,e,i)};const h=await e.solveAll(o,r,i);if(t(r[l],Function))return{solved:!0,result:await r[l](...n(h))};if(t(s(r)[l],Function))return{solved:!0,result:await s(r)[l](...n(h))};if(t(window[l],Function))return{solved:!0,result:await window[l](...n(h))}}return{solved:!1,result:null}}class ee extends Z{async perform(e,n,r){const i=await e.solve(this.l,n,r),a=this.r.expand(),l=o(s(i),n),{solved:c,result:h}=await Q(e,n,r,i,a,l);if(c)return h;const u=await e.solveAll(this.r,n,r);return i?.settable?t(i.through.from,D)?i.set(u.join(" ")):i.set(u[0]):n[l]=s(u[0])}}class te extends Z{async perform(e,t,n){const r=await e.solve(this.l,t,n),i=this.r.expand(),a=o(s(r),t),{solved:l,result:c}=await Q(e,t,n,r,i,a);if(l)return c;throw new y(`Cannot call '${r.toString()}': not a function or callable object.`)}}class se extends Z{async perform(e,n,i){let a;a=t(this.l,P)&&!this.l.isReservedWord()&&void 0!==o(this.l.value,n)?n[o(this.l.value,n)]:await e.solve(this.l,n,i);let l=await e.solveAll(this.r,s(a),i);for(let h of l){if(h=await e.solve(h,n,i),t(s(a),Element)){if(t(r(h),j,D)){a=await r(h).solve(e,s(a),i);continue}if(t(r(h),V)){a=new x(ue.from(s(a)).data[r(h).value],this,{parent:ue.from(s(a)).data,key:r(h).value});continue}}a=s(a);const l=s(h);if(null==a)throw new y(`Cannot resolve member '${l}' of ${a}.`);const u=c.get(l,a);if(void 0!==u)a=new x(u,this,{parent:a});else{const e=void 0!==a[l]?l:o(l,a);a=new x(a[e],this,{parent:a,key:e})}}return a}}class ne extends Z{async perform(e,t,n){let{l:r,r:i}=await this.prepare(e,t,n);r=s(r);for(let s of i)s=await e.asString(s,t),r=new x(r[s],this,{parent:r,key:s});return r}}class re extends Z{async perform(e,n,r){let{l:i,r:a}=await this.prepare(e,n,r);if(i=i??n??e.target,t(s(a),Element)&&(a=s(a).innerHTML),t(s(i),Element))return s(i).innerHTML=a?.toString()??"";if(t(s(i),NodeList))return s(i)[0].innerHTML=a?.toString()??"";if(Array.isArray(s(i)))return s(i).append(s(a));throw new y(`Cannot insert into target of type '${typeof s(i)}'. Expected Element, NodeList, or Array.`)}}class ie extends Z{static unwrapDimension(e){return t(r(i(e)),M)?r(i(e)).number:e}static prefix(e,t){return e.toString().startsWith(t)?e.toString():t+e.toString()}static cast(e,t,s,n=""){return new e(s.scope,s.source,{tokenStart:s.tokenStart,tokenEnd:s.tokenEnd,value:ie.prefix(t,n)})}static STRATEGIES={number:e=>Number(s(ie.unwrapDimension(e)))||0,float:e=>parseFloat(ie.unwrapDimension(e).toString()),int:e=>parseInt(ie.unwrapDimension(e).toString()),integer:e=>parseInt(ie.unwrapDimension(e).toString()),string:e=>e.toString(),boolean:e=>"false"!==e.toString()&&0!=s(e)&&!!s(e),id:(e,t,s,n,r)=>ie.cast(U,e,r,"#").solve(t,s,n),class:(e,t,s,n,r)=>ie.cast(W,e,r,".").solve(t,s,n),json:e=>JSON.stringify(s(e)),fragment:e=>{const t=document.createElement("template");return t.innerHTML=e.toString(),t.content},selector:(e,t,s,n,r)=>ie.cast(B,e,r).solve(t,s,n),attribute:(e,t,s,n,r)=>ie.cast(j,e,r).solve(t,s,n),css_property:(e,t,s,n,r)=>ie.cast(D,e,r).solve(t,s,n),dimension:(e,t,s,n,r)=>ie.cast(M,e,r).solve(t,s,n),variable:(e,t,s,n,r)=>ie.cast(V,e,r).solve(t,s,n)};async perform(e,t,s){let{l:n,r:r}=await this.prepare(e,t,s);const i=ie.STRATEGIES[r.toString()];if(i)return await i(n,e,t,s,this)}}class ae extends Z{static is_in(e,n){return Array.isArray(s(n))?n.includes(s(e)):t(s(n),Object)?Object.keys(s(n)).includes(e.toString()):"string"==typeof s(n)&&s(n).includes(e.toString())}async perform(e,t,s){return this.performWith(e,t,s,ae.is_in)}}const oe={CastOperation:ie,InsertExpression:re,IsTypeOperation:class extends Z{async perform(e,n,o){let{l:l,r:c}=await this.prepare(e,n,o);const h=c.toString();if(t(s(l),Element))return t(r(c),H)?s(l).tagName.toLowerCase()===r(c).value.toLowerCase():s(l).tagName.toLowerCase()===h.toLowerCase();if("float"===h)return"number"==typeof s(l)&&!Number.isNaN(s(l));if("integer"===h||"int"===h)return"number"==typeof s(l)&&Number.isInteger(s(l));let u=a(h);u=u.charAt(0).toUpperCase()+u.slice(1);const p=r(i(l));if(p&&p.constructor?.name===u)return!0;const d=s(l);return null!=d&&d.constructor?.name===u||t(s(l),c.value)}},OrOperation:class extends Z{async perform(e,t,n){const r=await e.solve(this.l,t,n);return s(r)?r:s(r)||await e.asValueOf(this.r,t)}},RescueOperation:class extends Z{async perform(e,s,n){try{return await e.solve(this.l,s,n)}catch(r){if(t(r,O))throw r;if(t(this.r,G)){const t=e.scopeData(this.r);t.exception=r,t.exception.message=r.actException.message}return await e.solve(this.r,s,n)}}},SetExpression:class extends Z{async perform(e,n,i){const{l:o,r:l}=await this.prepare(e,n,i);if(o?.settable)return t(r(o),D)?o.set(l.join(" ")):o.set(l);{let e=o.toString();return xe.config.convertToCamelCase&&(e=a(e)),n[e]=s(l),s(l)}}},ThenOperation:class extends Z{async perform(e,t,s){return await e.solve(this.r,await e.asValueOf(this.l,t),s)}},AndOperation:class extends Z{async perform(e,t,n){const r=await e.solve(this.l,t,n);return s(r)?s(r)&&await e.asValueOf(this.r,t):s(r)}},IsInOperation:ae};[["Mod",(e,t)=>e%t],["Sub",(e,t)=>e-t],["Add",(e,t)=>e+t],["Div",(e,t)=>e/t],["Mul",(e,t)=>e*t],["Like",(e,t)=>e==t],["NotLike",(e,t)=>e!=t],["Equal",(e,t)=>e===t],["NotEqual",(e,t)=>e!==t],["Gt",(e,t)=>e>t],["Gte",(e,t)=>e>=t],["Lt",(e,t)=>e<t],["Lte",(e,t)=>e<=t],["IsNotIn",(e,t)=>!ae.is_in(e,t)],["SubSet",(e,t)=>e.set(e-t),!0],["AddSet",(e,t)=>e.set(e+t),!0]].forEach(([e,n,a])=>{const o=class extends Z{async perform(e,o,l){if(a)return this.performWith(e,o,l,n);const{l:c,r:h}=await this.prepare(e,o,l);return t(r(i(c)),M)&&t(r(i(h)),M)&&c.unit===h.unit?new w({number:n(s(c),s(h)),unit:c.unit},this):n(s(c),s(h))}};Object.defineProperty(o,"name",{value:e+"Operation"}),oe[e+"Operation"]=o});class le{static debug=!1;static Token=class{constructor(e,t,s,n,r){this.type=e,this.value=t,this.index=s,this.line=n,this.column=r}get indexEnd(){return this.index+this.value.length}};static VALUES={arrow:"parseFunction",string:"parseString",url:"parseUrl",path:"parsePath",list:"parseList",prefix:"parsePrefixedValue",dot:"parseClass",lcurly:"parseSelectorTemplate",backtick:"parseTemplateValue",word:"parseSimple",number:"parseSimple",cssProp:"parseSimple",dimension:"parseSimple",attribute:"parseSimple",variable:"parseSimple",id:"parseSimple",property:"parseSimple",tag:"parseSimple",lparen:"parseScope",do:"parseScope",lbrace:"parseCollection"};static PREFIXES=Object.keys(c.prefixes);static EXPRESSIONS={bang:"parseCallExpressionEmpty",call:"parseCallExpression",colon:"parseActExpression",dot:"parseAtExpression",insert:"parseInsertExpression",lbrace:"parseSubscriptExpression",lparen:"parseCallExpressionParens"};static OPERATORS={"+":"AddOperation","-":"SubOperation","*":"MulOperation","/":"DivOperation","%":"ModOperation",and:"AndOperation",or:"OrOperation",is:"EqualOperation",is_not:"NotEqualOperation","<":"LtOperation","<=":"LteOperation",">":"GtOperation",">=":"GteOperation","==":"LikeOperation","!=":"NotLikeOperation","=":"SetExpression","+=":"AddSetOperation","-=":"SubSetOperation",as:"CastOperation",rescue:"RescueOperation",is_a:"IsTypeOperation",is_an:"IsTypeOperation",then:"ThenOperation","|":"ThenOperation","<<":"InsertExpression",is_in:"IsInOperation",is_not_in:"IsNotInOperation"};static SENTENCE_END={";":"sync","&":"async","?":"condition","else?":"branch",">>":"fwd"};static TOKENS=[["sentence_end",RegExp(Object.keys(this.SENTENCE_END).map(e=>l(e)).join("|"))],["string",/"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'/],["url",/https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._+~#=]{2,256}\.[a-z]{2,63}\b[-a-zA-Z0-9@:%_+.~#?&\/=]*/],["comment",/\/\*[\s\S]*?\*\/|\/\/.*/],["insert",/(?:^|\s+)<<\s+/],["operator",RegExp(Object.keys(this.OPERATORS).map(e=>"\\s+"+l(e)+"\\s+").join("|"))],["space",/\s+/],["lparen",/\(/],["rparen",/\)/],["do",/\bdo\b/],["end",/\bend\b/],["list",/\.\.\./],["dot",/\./],["call",/!:/],["bang",/!/],["variable",/\$[a-zA-Z0-9_\-]+/],["cssProp",/\*[a-zA-Z0-9_\-]+/],["attribute",/@[a-zA-Z0-9_\-]+/],["dimension",/-?\d+(?:\.\d+)?[a-z%]+/],["number",/-?\d+(?:\.\d+)?/],["id",/#[a-zA-Z0-9_\-]+/],["tag",/<[a-zA-Z0-9_\-]+>/],["path",/\/\b[-a-zA-Z0-9@:%_+.~#?&\/=]*/],["property",/:[a-zA-Z0-9_\-]+/],["arrow",/->/],["prefix",RegExp(`\\b(?:${this.PREFIXES.join("|")})\\b`)],["word",/[a-zA-Z0-9_\-]+/],["colon",/:/],["comma",/,/],["lcurly",/\{/],["rcurly",/}/],["lbrace",/\[/],["rbrace",/]/],["backtick",/`/],["backslash",/\\/],["unclosedComment",/\/\*/],["unclosedString",/["']/],["unknown",/./]];static TPL_TOKENS=[["lcurly",/\{/],["rcurly",/}/],["backtick",/`/],["backslash",/\\/],["content",/[^{}`\\]+/]];static TPL_TOKENS_START=["lcurly","backtick"];static TPL_TOKENS_END=["rcurly","backtick"];static LANG_REGEX=new RegExp(this.TOKENS.map(e=>`(${e[1].source})`).join("|"),"gy");static TPL_REGEX=new RegExp(this.TPL_TOKENS.map(e=>`(${e[1].source})`).join("|"),"gy");constructor(e){this.input=e+"\n;",this.wasBackslash=!1,this.langRegex=new RegExp(le.LANG_REGEX.source,"gy"),this.tplRegex=new RegExp(le.TPL_REGEX.source,"gy"),this.regex=this.langRegex,this.tplMode=!1,this.tokens=[new le.Token(null,"",0,0,0),new le.Token(null,"",0,0,0)],this.index=0,this.line=1,this.column=0}hasMoreTokens(){return this.input.length>this.index}setTplMode(e){le.debug&&console.warn(`Lexer setTplMode: Lexer set to ${e?"template":"language"} mode.`),this.tplMode=e,this.regex=e?this.tplRegex:this.langRegex,this.regex.lastIndex=this.index}next(){for(;this.hasMoreTokens();){this.regex.lastIndex=this.index;const e=this.regex.exec(this.input);if(!e||0===e[0].length){this.index++;continue}const t=e.findIndex((e,t)=>t>0&&void 0!==e),s=(this.tplMode?le.TPL_TOKENS:le.TOKENS)[t-1][0],n=e[0];if(this.index=this.regex.lastIndex,this.wasBackslash||(!this.tplMode&&le.TPL_TOKENS_START.includes(s)?this.setTplMode(!0):this.tplMode&&"lcurly"==s?this.setTplMode(!1):this.tplMode||"rcurly"!=s?this.tplMode&&le.TPL_TOKENS_END.includes(s)&&this.setTplMode(!1):this.setTplMode(!0)),this.wasBackslash="backslash"==s&&!this.wasBackslash,n.includes("\n")){const e=(n.match(/\n/g)||[]).length;this.line+=e,this.column=n.length-e}else this.column+=n.length;if(this.tokens.shift(),this.tokens.push(new le.Token(s,n,e.index,this.line,this.column)),xe.config.lexerDebug&&this.debugNext(),"comment"!=s)return this}return this}debugNext(){console.log(this.input.substring(0,this.index)+"â¬…ï¸"+this.input.substring(this.index)),console.trace(`Lexer next() (${this.tplMode?"template":"lang"} mode)`,this.peek())}peek(){return this.tokens[1]}prev(){return this.tokens[0]}tokenIs(...e){return e.includes(this.peek().type)}tokenIsEnd(){return this.tokenIs("sentence_end","rparen","end","rcurly")}tokenIsValue(){return this.tokenIs(...Object.keys(le.VALUES))}tokenIsExpression(){return this.tokenIs(...Object.keys(le.EXPRESSIONS))}tokenIsOperator(){return le.OPERATORS[this.peek().value.trim()]}fail(e){const t=new E(`at line ${this.line}, column ${this.column}: ${e}`);throw t.token=this.peek(),t}expect(...e){if(this.tokenIs(...e))return this;this.fail(`Unexpected ${this.peek().type} "${this.peek().value}", expected a token of type ${e.join(", ")}.`)}expectValue(){if(this.tokenIsValue())return this;this.fail(`Unexpected ${this.peek().type} "${this.peek().value}", expected a value token.`)}expectEnd(){return this.expect("sentence_end","rparen","end")}nextIf(...e){return!!this.tokenIs(...e)&&this.next()}consume(...e){return!(0!==e.length&&!this.tokenIs(...e))&&this.next().fwd()}fwd(){for(;this.nextIf("space"););return this}fwdWithComma(){for(;this.nextIf("space","comma"););return this}}class ce{static debug=!1;static VALUES={word:[P],number:[L,e=>parseFloat(e)],cssProp:[D,e=>e.slice(1)],dimension:[M],attribute:[j,e=>e.slice(1)],variable:[V,e=>e.slice(1)],id:[U],property:[$,e=>e.slice(1)],tag:[H,e=>e.slice(1,-1)]};static ESCAPE_CHARS={"'":"'",'"':'"',"`":"`","\\":"\\",n:"\n",r:"\r",t:"\t",b:"\b",f:"\f","{":"{","}":"}"};constructor(e){this.source=e,this.lexer=new le(this.source.code),this.lexer.next()}isKeyword(e){return t(e,P)&&Object.hasOwn(c.keywords,e.value)}parse(){const e=new G(null,this.source);for(e.tokenStart=this.lexer.peek();this.lexer.hasMoreTokens();){const t=this.parseSentence(e);t&&e.value.push(t),this.lexer.expect("sentence_end","rparen","end","space").next()}return e.tokenEnd=this.lexer.peek(),ce.debug&&console.warn("Parser.parse() finished\n",e,this.source),e}parseSentence(e){if(this.lexer.fwd(),this.lexer.tokenIsEnd())return;const t=new F(e,this.source);t.tokenStart=this.lexer.peek();let s,n=this.parseExpression(e);return this.lexer.nextIf("space")&&this.lexer.fwd().tokenIsValue()&&(s=n,n=this.parseExpression(e)),t.target=s,t.value=n,t.mode=le.SENTENCE_END[this.lexer.fwd().peek().value]||"sync",t.tokenEnd=this.lexer.peek(),t}parseExpression(e,t=[]){let s;if(this.lexer.tokenIsValue()?s=this.parseValue(e):this.lexer.tokenIs("insert")||this.lexer.fail(`Unexpected token ${this.lexer.peek().type} "${this.lexer.peek().value}" while parsing an expression. A value token or an insert token were expected.`),this.lexer.tokenIs(...t))return s;if(this.isKeyword(s)&&(s=this.parseKeywordExpression(e,s)),this.lexer.tokenIsEnd()&&!this.lexer.tokenIs("rparen","end"))return s;for(;!this.lexer.tokenIsEnd()&&this.lexer.hasMoreTokens();)if(this.lexer.tokenIsExpression())s=this[le.EXPRESSIONS[this.lexer.peek().type]](e,s,[...t,"insert"]);else{if(!this.lexer.tokenIsOperator())break;s=this.parseOperator(e,s,[...t,"insert"])}return s}parseOperator(e,t,s=[]){const n=new(oe[le.OPERATORS[this.lexer.peek().value.trim()]])(e,this.source,{tokenStart:t.tokenStart});return n.l=t,this.lexer.consume(),n.r=this.parseExpression(e,["operator",...s]),n.tokenEnd=this.lexer.prev(),n}parseKeywordExpression(e,t){const s=new J(e,this.source,{tokenStart:t.tokenStart});for(s.l=t,s.r=new _,this.lexer.fwd();!this.lexer.nextIf("comma")&&this.lexer.hasMoreTokens()&&!this.lexer.tokenIsEnd()&&!this.lexer.tokenIsOperator();)s.r.push(this.parseExpression(e)),this.lexer.fwd();return s.tokenEnd=this.lexer.peek(),s}parseAtExpression(e,t){this.lexer.expect("dot");const s=new se(e,this.source,{tokenStart:t.tokenStart});for(s.l=t,s.r=new _;this.lexer.nextIf("dot")&&this.lexer.hasMoreTokens();)this.lexer.expect("word","attribute","cssProp","variable","lparen"),s.r.push(this.parseValue(e));return s.tokenEnd=this.lexer.prev(),s}parseSubscriptExpression(e,t){this.lexer.expect("lbrace");const s=new ne(e,this.source,{tokenStart:t.tokenStart});for(s.l=t,s.r=new _;this.lexer.nextIf("lbrace")&&this.lexer.hasMoreTokens();)this.lexer.fwd().expectValue(),s.r.push(this.parseExpression(e,["rbrace"])),this.lexer.fwd().nextIf("rbrace");return s.tokenEnd=this.lexer.peek(),s}parseCallExpressionEmpty(e,t){this.lexer.expect("bang").next();const s=new te(e,this.source,{tokenStart:t.tokenStart});return s.l=t,s.r=new _,s.tokenEnd=this.lexer.peek(),s}parseInsertExpression(e,t,s=[]){this.lexer.expect("insert").next().fwd();const n=new re(e,this.source);return void 0===t?n.tokenStart=this.lexer.prev():(n.tokenStart=t.tokenStart,n.l=t),n.r=this.parseExpression(e,s),n.tokenEnd=this.lexer.peek(),n}parseCallExpression(e,t,s=[]){this.lexer.expect("call").consume();const n=new te(e,this.source,{tokenStart:t.tokenStart});for(n.l=t,n.r=new _;!this.lexer.tokenIs("comma")&&!this.lexer.tokenIsEnd()&&this.lexer.hasMoreTokens()&&!this.lexer.tokenIs(...s);)n.r.push(this.parseExpression(e,s)),this.lexer.fwd();return n.tokenEnd=this.lexer.peek(),n}parseCallExpressionParens(e,t,s=[]){this.lexer.expect("lparen").consume();const n=new te(e,this.source,{tokenStart:t.tokenStart});for(n.l=t,n.r=new _;!this.lexer.nextIf("rparen")&&this.lexer.hasMoreTokens()&&!this.lexer.tokenIs(...s);)n.r.push(this.parseExpression(e,s)),this.lexer.fwdWithComma();return n.tokenEnd=this.lexer.prev(),n}parseActExpression(e,t,s=[]){this.lexer.expect("colon").consume();const n=new ee(e,this.source,{tokenStart:t.tokenStart});for(n.l=t,n.r=new _;!this.lexer.nextIf("comma")&&!this.lexer.tokenIsEnd()&&this.lexer.hasMoreTokens()&&!this.lexer.tokenIs(...s);)n.r.push(this.parseExpression(e,s)),this.lexer.fwd();return n.tokenEnd=this.lexer.peek(),n}parseValue(e){this.lexer.expectValue();const s=this.lexer.peek(),n=this[le.VALUES[this.lexer.peek().type]](e);return n.tokenStart=s,n.tokenEnd=this.lexer.peek(),t(n,_,A,Y)||this.lexer.next(),n}parseScope(e){const t=new G(e,this.source);t.tokenStart=this.lexer.peek();const s=this.lexer.expect("lparen","do").tokenIs("do")?"end":"rparen";for(this.lexer.next();!this.lexer.tokenIs(s)&&this.lexer.hasMoreTokens();){const e=this.parseSentence(t);e&&t.value.push(e),this.lexer.tokenIsEnd()&&!this.lexer.tokenIs(s)&&this.lexer.next().fwd()}return t.tokenEnd=this.lexer.peek(),t}parseCollection(e){if(this.lexer.expect("lbrace").consume(),this.lexer.nextIf("colon")&&this.lexer.fwd().tokenIs("rbrace"))return new X(e,this.source,{value:new Map});if(this.lexer.fwd().nextIf("rbrace"))return new K(e,this.source,{value:[]});const t=this.parseExpression(e,["colon"]);if(this.lexer.fwd(),this.lexer.nextIf("comma")||this.lexer.tokenIsValue()||this.lexer.tokenIs("rbrace"))return this.lexer.fwd(),new K(e,this.source,{value:this.parseArray(e,t)});if(this.lexer.nextIf("colon")){this.lexer.fwd();const s=new G(e,this.source);return new X(s,this.source,{value:this.parseObject(s,t)})}this.lexer.fail(`Unexpected token ${this.lexer.peek().type} "${this.lexer.peek().value}" while parsing a collection. Only colon, comma, rbrace and value tokens where expected.`)}parseArray(e,t){const s=[];for(s.push(t),this.lexer.fwd();!this.lexer.tokenIs("rbrace")&&this.lexer.hasMoreTokens();)s.push(this.parseExpression(e,["colon"])),this.lexer.fwdWithComma();return this.lexer.expect("rbrace"),s}parseObject(e,t){const s=new Map;for(s.set(t,this.parseExpression(e,["colon"])),this.lexer.fwdWithComma();!this.lexer.tokenIs("rbrace")&&this.lexer.hasMoreTokens();)t=this.parseExpression(e,["colon"]),this.lexer.fwd().expect("colon").consume(),s.set(t,this.parseExpression(e,["colon"])),this.lexer.fwdWithComma();return this.lexer.expect("rbrace"),s}parseString(e){return this.lexer.expect("string"),new N(e,this.source,{value:this.lexer.peek().value.slice(1,-1).replace(/\\(.)/g,(e,t)=>ce.ESCAPE_CHARS[t]||t)})}parseFunction(e){this.lexer.expect("arrow").next().fwd().expect("variable","list","lparen","do");const t={args:[]};for(;this.lexer.tokenIs("variable")&&this.lexer.hasMoreTokens();)t.args.push(this.lexer.peek().value.slice(1)),this.lexer.next().fwd();return this.lexer.nextIf("list")&&(this.lexer.expect("variable"),t.args.push([this.lexer.peek().value.slice(1)]),this.lexer.next().fwd()),t.scope=this.parseScope(e),new q(e,this.source,{value:t})}parseTemplate(e,t,s){let n="";const r=new G(e,this.source);for(this.lexer.expect(t).next();!this.lexer.tokenIs(s)&&this.lexer.hasMoreTokens();){if(this.lexer.nextIf("lcurly")){for(;!this.lexer.tplMode&&this.lexer.hasMoreTokens();){const e=this.parseSentence(r);e?(r.value.push(e),n+=I.interpolation(r.value.length-1)):this.lexer.next()}this.lexer.next()}if(!this.lexer.tokenIs(s,"lcurly")){if(this.lexer.nextIf("backslash")){const e=ce.ESCAPE_CHARS[this.lexer.peek().value[0]];e&&(n+=e),n+=this.lexer.peek().value.slice(1)}else n+=this.lexer.peek().value;this.lexer.next()}}return this.lexer.expect(s),{template:n,scope:r.value.length>0?r:null}}parseTemplateValue(e,t="backtick",s="backtick"){return new I(e,this.source,{value:this.parseTemplate(e,t,s)})}parseSelectorTemplate(e){return new B(e,this.source,{value:this.parseTemplateValue(e,"lcurly","rcurly")})}parseSimple(e){const t=this.lexer.peek().type,[s,n=e=>e]=ce.VALUES[t];return this.lexer.expect(t),new s(e,this.source,{value:n(this.lexer.peek().value)})}parseClass(e){return this.lexer.expect("dot").next().expect("word"),new W(e,this.source,{value:"."+this.lexer.peek().value})}parsePath(e){this.lexer.expect("path");const t=window.location.origin+this.lexer.peek().value;t.length>2048&&this.lexer.fail("URL exceeds maximum length of 2048 characters.");const s=URL.parse(t);return null===s&&this.lexer.fail(`Invalid URL "${t}"`),["http:","https:"].includes(s.protocol)||this.lexer.fail(`Invalid protocol "${s.protocol}" in URL "${t}". Only http: and https: are allowed.`),new R(e,this.source,{value:s})}parseUrl(e){this.lexer.expect("url");const t=this.lexer.peek().value;t.length>2048&&this.lexer.fail("URL exceeds maximum length of 2048 characters.");const s=URL.parse(t);return null===s&&this.lexer.fail(`Invalid URL "${t}"`),["http:","https:","ws:","wss:","file:"].includes(s.protocol)||this.lexer.fail(`Invalid protocol "${s.protocol}" in URL "${t}". Only http:, https:, ws:, wss:, and file: are allowed.`),new R(e,this.source,{value:s})}parseList(e){return this.lexer.expect("list").next(),new A(e,this.source,{value:this.parseExpression(e)})}parsePrefixedValue(e){this.lexer.expect("prefix");const t=this.lexer.peek().value;return this.lexer.next().fwd().expectValue(),new Y(e,this.source,{l:t,r:this.parseValue(e)})}}class he{args=[];attr;#e;scope;type;get code(){return null!==this.#e?this.#e:"directAttribute"==this.type?this.attr.value:"inlineScript"==this.type?this.attr.ownerElement.innerHTML:void 0}get element(){return"actrun"==this.type?document.body:"directAttribute"==this.type?this.attr.ownerElement:this.attr.ownerElement.parentNode}constructor(e,s,n=null,r=null){if(this.attr=e,this.type=s,this.#e=n,t(r,G))this.scope=r;else try{const e=new ce(this);this.scope=e.parse()}catch(e){const t=this.code.split("\n"),s=t[Math.max(0,e.token.line-1)],n=["%cðŸ’£ act Syntax Error","font-weight: bold; font-size: 1.1em;","\n","while parsing Source",this,"\n","for element",this.element,"\n"];throw this.attr&&n.push(`in attribute "${this.attr.name}" of element`,this.attr.ownerElement,"\n"),n.push(e.message,"\n\n"),e.token.line-1>1&&n.push(t[e.token.line-2],"\n"),n.push(s.substring(0,e.token.column-e.token.value.length)+"âš ï¸âž¡ï¸"+s.substring(e.token.column-e.token.value.length,e.token.column)+"â¬…ï¸âš ï¸"+s.substring(e.token.column)+"\n"),t.length-e.token.line>1&&n.push(t[e.token.line],"\n"),console.error(...n),e}}}const ue={PROP:"__act__",ATTRIBUTES:["act","act-block"],EVENT_OPTIONS:["once","prevent","stop","only","target"],INTERSECT_EVENTS:{inview:"actinview",offview:"actoffview"},from(e,t=!1){const s=e[ue.PROP];return!s&&t?new pe(e):s},eventName:e=>Object.keys(ue.INTERSECT_EVENTS).includes(e)?ue.INTERSECT_EVENTS[e]:e,bind(e){if(t(e,HTMLScriptElement)&&"text/act"==e.attributes.type?.value)return this.bindScript(e);const s=this.from(e,!0);this.bindAttributes(e,s)},bindScript(e){const t=e.parentNode,s=this.from(t,!0);if(e.hasAttribute("src"))return(async()=>{const n=await fetch(e.src,{method:"GET",headers:{"Content-Type":"text/plain"}}).then(e=>e.text()),r=new he(e.attributes.src,"externalScript",n);xe.config.start&&t.dispatchEvent(new Event("actscriptloaded",{detail:{element:e}})),s.addEvent("act",r)})();e.hasAttribute("act-block")||Array.from(e.attributes).some(e=>"act"==e.name||e.name.startsWith("act@"))||e.setAttribute("act",""),this.bindAttributes(e,s,"inlineScript")},bindAttributes(e,t,s="directAttribute"){for(const n of e.attributes)(this.ATTRIBUTES.includes(n.name)||n.name.startsWith("act@"))&&this.bindSource(t,new he(n,s))},bindSource(e,t){if("act-block"==t.attr.name)return this.bindBlock(e,t);this.bindEvents(e,t)},bindBlock(e,t){const[s,...n]=t.attr.value.replaceAll("$","").split(" ");t.args=n,e.blocks[s]=t},bindEvents(e,t){t.attr.name.replace("act@","").split(",").forEach(s=>{const n={};this.EVENT_OPTIONS.forEach(e=>{s.includes(":"+e)&&(n[e]=!0,s=s.replace(":"+e,""))});let r,i=null;(r=s.match(/\[(.*?)\](.*)/))&&(i=r[1],s=r[2]);const[a,...o]=s.split(".");o.length&&(n.modifiers=o),e.addEvent(a,t,n,null,i)})},scan(e,t=!0,s=!1){if(this.from(e)&&!s)return;t&&this.bind(e);const n=(new XPathEvaluator).createExpression('.//script[@type = "text/act"] | .//*[@act] | .//*[@*[starts-with(name(), "act@")]]').evaluate(e,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(let e=0;e<n.snapshotLength;e++){const t=n.snapshotItem(e);this.from(t)&&!s||this.bind(t)}}};class pe{data;element;events={};blocks={};constructor(e){this.element=e,this.data={},Object.defineProperty(e,ue.PROP,{value:this,writable:!0,configurable:!0})}#t(e,s){const n={},r=this.element;s.threshold&&(n.threshold=s.threshold),t(s.root,Element)&&(n.root=s.root),void 0!==s.rootMargin&&(n.rootMargin=s.rootMargin.toString());new IntersectionObserver(function(t){for(const n of t)if(n.isIntersecting===(e==ue.INTERSECT_EVENTS.inview)){s.once&&this.unobserve(r),r.dispatchEvent(new Event(e,{detail:{entry:n}}));break}},n).observe(r)}addEvent(e,t,s={},n=null,r=null){null===r&&(r=e),Object.keys(ue.INTERSECT_EVENTS).includes(e)&&(e=ue.INTERSECT_EVENTS[e],this.#t(e,s)),n||(n=new de(this,e,s,t,t.scope)),this.events[r]=n,this.element.addEventListener(e,n.listener,s),"act"===e&&xe.config.start&&this.element.dispatchEvent(new Event("act",{bubbles:!1}))}parent(){let e=this.element;for(;e=e.parentNode;)if(ue.from(e))return ue.from(e)}getBlock(e){return this.lookupBlock(e)?.block}lookupBlock(e){let t=this;for(;t;){if(Object.hasOwn(t.blocks,e))return{block:t.blocks[e],binding:t};t=t.parent()}}lookupData(e){let t=this;for(;t;){if(Object.hasOwn(t.data,e))return new x(t.data[e],t,{parent:t.data,key:e});t=t.parent()}}}class de{binding;name;options;source;scope;lock=!1;halt=!1;constructor(e,t,s,n,r){this.binding=e,this.name=t,this.options=s,this.scope=r,this.source=n,this.contexts=new Set,this.listener=e=>{const t=this.options.modifiers?.map(e=>e.toLowerCase());if(t){if(["shift","ctrl","alt","meta"].some(s=>(t.includes(s)||"ctrl"===s&&t.includes("control"))&&!e[s+"Key"]))return;const s=t.filter(e=>!["shift","ctrl","control","alt","meta"].includes(e));if(s.length&&(!e.key||!s.includes(e.key.toLowerCase())))return}return this.options.prevent&&e.preventDefault(),this.options.stop&&e.stopPropagation(),this.options.only&&e.stopImmediatePropagation(),this.run(this.options.target?e.target:this.binding.element,e)}}async run(e,s=null){if(this.lock)return;const n=new fe(e,this.binding,s,this,this.source);try{return this.attach(n),n.scopeData(this.scope).event=s,await n.solve(this.scope,e,{})}catch(e){if(t(e,O.Halt,O.Stop))return e.data;if(t(e,S)&&e.actTrace?.length){const t=e.expression,s=e.actException??e,n=e.actTrace[0];console.error("%cðŸ’£ act Runtime Error","font-weight: bold; font-size: 1.2em;"),console.group(`%c${s.constructor.name}%c${s.message?": "+s.message:""}`,"background: rgba(255, 0, 0, 0.1); font-weight: bold; padding: 2px 4px;","background: rgba(255, 0, 0, 0.1); padding: 2px 4px;"),console.log("At line",t.tokenStart.line,"Column",t.tokenStart.column,`\nOn event: '${n.context.event?.type??"unknown"}'`,n.context.event,"\nFrom event manager:",n.context.eventManager,`\nSource: ${n.sentence.source.type}`,n.sentence.source,"\nElement binding:",n.context.binding.element),console.groupCollapsed("Stack trace");for(const s of e.actTrace){const e=s.sentence,n=e.code.split("\n"),r=n[0],i=n.length>1,a=r.substring(0,t.tokenStart.index-e.tokenStart.index),o=r.substring(t.tokenStart.index-e.tokenStart.index,t.tokenEnd.indexEnd-e.tokenStart.index),l=r.substring(t.tokenEnd.indexEnd-e.tokenStart.index);t&&o?console.groupCollapsed(`%cLine ${e.tokenStart.line}:\n%c ${a}%c${o}%c${l}${i?"%c ...":""}`,"color: gray;","","background: rgba(255, 0, 0, 0.2); font-weight: bold; padding: 1px 4px; border-radius: 4px; border: 1px solid rgba(255, 0, 0, 0.3);","",...i?["color: gray; font-style: italic;"]:[]):console.groupCollapsed(`%cLine ${e.tokenStart.line}:\n%c ${r.trim()}${i?"%c ...":""}`,"color: gray;","",...i?["color: gray; font-style: italic;"]:[]),console.log("Sentence details:\n","\nTarget:\n",e.target,"\nComputed sentence target:\n",s.sentenceTarget,"\nSource:\n",e.source,"\nSentence object:\n",e,"\nFull code:\n\n"+e.code),console.groupEnd()}console.groupEnd(),console.groupCollapsed("Full trace data"),console.log(e.actTrace),console.groupEnd(),console.groupCollapsed("JavaScript Exception"),console.error(e.actException),console.groupEnd(),console.groupEnd()}}finally{this.detach(n)}}attach(e){this.contexts.add(e)}detach(e){this.contexts.delete(e),0===this.contexts.size&&(this.halt=!1)}}class fe{binding;data;event;eventManager;source;constructor(e,t,s,n,r){this.target=e,this.binding=t,this.event=s,this.eventManager=n,this.source=r,this.data=new WeakMap}async solve(e,s,n){if(this.eventManager.halt)throw new O.Halt;return t(e,T,_)?await e.solve(this,s,n):e}async solveAll(e,s,n){if(t(e,_))return await e.solve(this,s,n);const r=[];for(const i of e)t(i,A)?r.push(...await this.solve(i,s,n)):r.push(await this.solve(i,s,n));return r}async asString(e,t,s){const n=await this.solve(e,t,s);return void 0===n?"":n.toString()}async asValueOf(e,t,n){return s(await this.solve(e,t,n))}scopeData(e){return this.data.has(e)||this.data.set(e,{}),this.data.get(e)}spawn(){return new fe(this.target,this.binding,this.event,this.eventManager,this.source)}}const xe=e.Act={get version(){return"0.1.0"},config:{convertToCamelCase:!0,start:!0,debug:!1,debugLexer:!1,debugParser:!1,startTime:!0,sanitize:!1,sanitizer:null},configure(){const e=document.querySelectorAll('meta[name="act-config"]'),t={};for(const s of e){const[e,n]=s.content.split(":");t[e.trim()]=JSON.parse(n.trim())}Object.assign(this.config,t,window.__actConfig||{}),this.config.debugLexer&&(le.debug=!0),this.config.debugParser&&(ce.debug=!0)},start(){this.config.startTime&&console.time("act start"),new pe(window),this.init(document.body,!0),this.config.startTime&&console.timeEnd("act start")},init(e,t,s){ue.scan(e,t,s)},run(e,t){const s=ue.from(e,!0),n=new he(null,"actrun",t);return new de(s,"actrun",{},n,n.scope).run(e)},get globals(){return ue.from(document.body).data},is:t,unwrap:s,unwrapAll:n,from:r,through:i,Library:c}}(this);